<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Question Analysis Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="importmap">
    {
      "imports": {
        "@google/generative-ai": "https://esm.run/@google/generative-ai"
      }
    }
    </script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&family=Arial:wght@400;700&display=swap');
      body {
        font-family: 'Noto Sans KR', Arial, sans-serif;
      }
      @media print {
        @page {
          size: A4 portrait;
          margin: 1.5cm;
        }
        .analysis-card {
          page-break-inside: avoid;
        }
      }
    </style>
</head>
<body class="bg-slate-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
      import { GoogleGenerativeAI } from "@google/generative-ai";

      const API_KEY = "AIzaSyCAN3CHVuwJsS94wT-BsmD7HNad78jBVlc";

      // --- Constants ---
      const PROMPT_TEMPLATE = `
        Persona
        당신은 '문항 분석 프로(Question Analysis Pro)'라는 이름을 가진, 고등학교 시험 문항 분석을 위한 최고의 AI 전문가입니다. 당신은 교육 평가, 교과과정, 국어 어문 규범에 대한 깊이 있는 지식을 갖추고 있으며, 출제자의 의도를 존중하면서도 건설적인 피드백을 제공하는 데 능숙합니다. 당신의 분석은 항상 명확하고, 체계적이며, 시각적으로 이해하기 쉬운 '카드(Card)' 형식으로 제공됩니다.

        Context
        고등학교 선생님인 사용자가 자신이 출제한 정기고사(중간고사 또는 기말고사) 텍스트 파일을 업로드합니다. 당신의 임무는 이 시험지를 문항별로 심층 분석하고, 그 결과를 아래에 정의된 '분석 카드' 형식에 맞춰 생성하는 것입니다. 최종 목표는 선생님이 문항의 질을 높이고, 학생들의 학업 성취도를 더 정확하게 평가할 수 있도록 돕는 것입니다.

        Input Variable
        {{exam_text}}: 사용자가 업로드한 시험지 전체 텍스트입니다. 문항 번호, 문제, 보기, 배점 등의 정보가 포함됩니다.

        Instructions
        {{exam_text}}를 기반으로, 다음 규칙에 따라 문항 분석 결과를 생성하세요. 모든 설명과 분석은 핵심 위주로 간결하게 작성합니다.

        1. 전체 구조:
        분석은 크게 <문항별 개별 분석>과 <총평 및 제언> 두 부분으로 구성됩니다.
        모든 결과물은 Markdown을 사용하여 명확하고 세련된 카드 형식으로 디자인합니다. 이모지를 적절히 활용하여 가독성을 높여주세요.

        2. 문항별 개별 분석 (Analysis Card):
        각 문항에 대해 아래 템플릿에 맞춰 하나의 '분석 카드'를 생성하세요.

        ## 📌 문항 [번호] 분석
        ### ✅ 정답 및 해설
        정답: (여기에 명확한 정답을 기재하세요. 예: ③)
        핵심 개념: (이 문항이 평가하고자 하는 핵심 개념이나 지식을 간략히 서술하세요.)
        상세 해설: (정답인 이유와 오답인 이유를 간결하게 설명합니다.)

        ### 🧐 문항 피드백 (간결하게 핵심만 요약)
        ✍️ 철자 및 어법: (철자, 띄어쓰기, 문법적 오류(비문) 등을 검토합니다. 오류가 없다면 '오류 없음'으로, 있다면 '수정 제안: "원본" → "수정본"' 형식으로 제시하세요.)
        ⚠️ 문항 오류 가능성: (사실 관계 오류, 복수 정답 가능성, 정답 없음, 지문/보기의 논리적 모순 등 문항 자체의 잠재적 오류를 분석합니다. 문제가 없다면 '오류 가능성 낮음'으로, 있다면 구체적인 이유와 근거를 제시하세요.)
        🎯 문항 적절성: (교육과정 성취 기준과의 부합도, 난이도(상/중/하), 발문의 명확성, 보기의 매력도 등을 종합적으로 평가합니다. '적절함', '개선 제안' 등으로 평가하고 이유를 간략히 덧붙이세요.)
        ⚖️ 예상 변별력: (해당 문항이 상위권, 중위권, 하위권 학생을 구별해낼 수 있는 정도를 '상/중/하'로 평가하고, 그 이유를 설명합니다. 예: '상 - 핵심 개념을 정확히 이해하고 함정 보기를 피해야 하므로 변별력 높음')

        3. 총평 및 제언 (Overall Feedback Card):
        모든 개별 문항 분석이 끝난 후, 시험 전체에 대한 종합적인 피드백 카드를 아래 템플릿에 맞춰 생성하세요.

        ## 📋 총평 및 제언 (간결하게 핵심만 요약)
        ### 👍 강점 (Strengths)
        (시험 전반에 걸쳐 잘된 점을 2-3가지 구체적으로 칭찬합니다. 예: 교육과정의 핵심 요소를 충실히 반영함, 다양한 유형의 문항을 균형 있게 출제함 등)

        ### 💡 개선 제안 (Suggestions for Improvement)
        (시험의 완성도를 더욱 높이기 위한 건설적인 제안을 2-3가지 제시합니다. 예: 일부 비문 수정 제안, 고난도 문항의 발문 명확화, 특정 유형 문항의 비중 조절 등)

        ### 📊 전체 난이도 및 변별력 분석
        전체 난이도: (시험의 전반적인 체감 난이도를 '상/중/하'로 평가하고, 그 근거를 제시합니다.)
        변별력 확보: (전체 시험이 학생들의 성취 수준을 효과적으로 변별할 수 있을지에 대한 종합적인 의견을 제시합니다. 특히 변별력을 가를 것으로 예상되는 '킬러 문항'을 언급하면 좋습니다.)

        시험지 텍스트:
        \`\`\`
        {{exam_text}}
        \`\`\`
        `;

      // --- Gemini Service ---
      let genAI;
      try {
        if (!API_KEY || API_KEY === "YOUR_API_KEY") {
            throw new Error("API_KEY is not set. Please replace 'YOUR_API_KEY' in the HTML file.");
        }
        genAI = new GoogleGenerativeAI(API_KEY);
      } catch (e) {
        console.error(e);
      }


      const fileToGenerativePart = async (file) => {
          const base64EncodedData = await new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onloadend = () => {
                  if (typeof reader.result === 'string') {
                      resolve(reader.result.split(',')[1]);
                  } else {
                      reject(new Error("Failed to read file as data URL"));
                  }
              };
              reader.onerror = (err) => reject(err);
              reader.readAsDataURL(file);
          });

          return {
              inlineData: {
                  data: base64EncodedData,
                  mimeType: file.type,
              },
          };
      };

      const readTextFromFile = (file) => {
          return new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = (e) => {
                  if (e.target?.result) {
                      resolve(e.target.result);
                  } else {
                      reject(new Error("Failed to read text from file."));
                  }
              };
              reader.onerror = (err) => reject(err);
              reader.readAsText(file, 'UTF-8');
          });
      };

      const analyzeExamStream = async (examFile) => {
        try {
          if (!genAI) {
            throw new Error("Gemini AI client is not initialized. Check your API key.");
          }
          const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
          const isTxt = examFile.type === 'text/plain' || examFile.name.endsWith('.txt');

          if (isTxt) {
              const examText = await readTextFromFile(examFile);
              const prompt = PROMPT_TEMPLATE.replace('{{exam_text}}', examText);
              const result = await model.generateContentStream(prompt);
              return result.stream;
          } else { // PDF file
              const filePart = await fileToGenerativePart(examFile);
              const promptForFile = PROMPT_TEMPLATE.replace(/시험지 텍스트:\s*```\s*{{exam_text}}\s*```/g, '').trim();

              const result = await model.generateContentStream([promptForFile, filePart]);
              return result.stream;
          }
        } catch (error) {
          console.error("Error calling Gemini API:", error);
          if (error.message.includes('API key not valid')) {
             throw new Error("Gemini API 키가 유효하지 않습니다. HTML 파일의 API_KEY를 확인해주세요.");
          }
          throw new Error("Gemini API에서 분석 결과를 가져오는 데 실패했습니다.");
        }
      };


      // --- Icons ---
      const BookCheckIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/>
          <path d="m9 9.5 2 2 4-4"/>
        </svg>
      );

      const UploadCloudIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/>
          <path d="M12 12v9"/>
          <path d="m16 16-4-4-4 4"/>
        </svg>
      );

      const FileTextIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/>
          <path d="M14 2v4a2 2 0 0 0 2 2h4"/>
          <path d="M16 13H8"/>
          <path d="M16 17H8"/>
          <path d="M10 9H8"/>
        </svg>
      );

      const BrainCircuitIcon = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
              <path d="M12 5a3 3 0 1 0-5.993.142"/><path d="M18 13a3 3 0 1 0-3-5.196"/>
              <path d="M12 19a3 3 0 1 0 5.993-.142"/><path d="M6 13a3 3 0 1 0 3 5.196"/>
              <path d="M12 12v.142a3 3 0 1 1-3 5.196"/><path d="M12 12v-.142a3 3 0 1 0 3-5.196"/>
              <path d="m14.5 7.5 1 1"/><path d="m9.5 7.5-1 1"/><path d="m14.5 16.5-1-1"/>
              <path d="m9.5 16.5 1-1"/><path d="M12 8v-3"/><path d="M12 22v-3"/>
              <path d="M19 12h3"/><path d="M2 12h3"/>
          </svg>
      );

      const PlusCircleIcon = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
              <circle cx="12" cy="12" r="10" /><line x1="12" y1="8" x2="12" y2="16" />
              <line x1="8" y1="12" x2="16" y2="12" />
          </svg>
      );

      const XCircleIcon = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
              <circle cx="12" cy="12" r="10" /><line x1="15" y1="9" x2="9" y2="15" />
              <line x1="9" y1="9" x2="15" y2="15" />
          </svg>
      );

      const PrintIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <polyline points="6 9 6 2 18 2 18 9" />
          <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" />
          <rect x="6" y="14" width="12" height="8" />
        </svg>
      );

      const DownloadIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
      );


      // --- Components ---
      const Header = () => {
        return (
          <header className="p-6 md:p-8 bg-gradient-to-r from-indigo-700 to-purple-600">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-4">
                <div className="bg-cyan-400/20 p-3 rounded-full">
                  <BookCheckIcon className="h-8 w-8 text-cyan-300" />
                </div>
                <div>
                  <h1 className="text-3xl font-bold text-slate-100">
                    문항 분석 프로
                  </h1>
                  <p className="text-cyan-300 mt-1">AI 기반 문항 심층 분석</p>
                </div>
              </div>
            </div>
          </header>
        );
      };

      const FileUpload = ({ onFileChange }) => {
        const fileInputRef = React.useRef(null);

        const handleFileChange = (event) => {
          const file = event.target.files?.[0];
          if (file) {
            onFileChange(file);
          }
        };

        const handleAreaClick = () => {
          fileInputRef.current?.click();
        };
        
        const handleDragOver = (event) => {
          event.preventDefault();
        };

        const handleDrop = (event) => {
          event.preventDefault();
          const file = event.dataTransfer.files?.[0];
          if (file) {
            onFileChange(file);
          }
        };

        return (
          <div
            onClick={handleAreaClick}
            onDragOver={handleDragOver}
            onDrop={handleDrop}
            className="border-2 border-dashed border-slate-600 rounded-xl p-8 text-center transition-colors bg-slate-800/50 hover:bg-slate-700/70 hover:border-slate-500 cursor-pointer"
          >
            <input
              type="file"
              ref={fileInputRef}
              onChange={handleFileChange}
              className="hidden"
              accept=".txt,text/plain,.pdf,application/pdf"
            />
            <div className="flex flex-col items-center justify-center">
                <>
                  <UploadCloudIcon className="h-12 w-12 text-blue-400 mb-4" />
                  <p className="text-lg font-semibold text-blue-300">파일을 드래그 앤 드롭하거나 클릭하여 업로드하세요</p>
                  <p className="text-sm text-slate-400 mt-1">(.txt 또는 .pdf 파일 형식만 지원)</p>
                </>
            </div>
          </div>
        );
      };
      
      const Loader = () => {
        return (
          <div className="flex flex-col items-center justify-center p-12">
            <svg className="animate-spin h-12 w-12 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
              <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p className="mt-4 text-lg font-semibold text-blue-300">AI가 문항을 분석하고 있습니다...</p>
            <p className="text-slate-400">잠시만 기다려주세요.</p>
          </div>
        );
      };

      const ExamInfoForm = ({
        schoolName, setSchoolName,
        academicYear, setAcademicYear,
        semester, setSemester,
        examType, setExamType,
        subjectName, setSubjectName
      }) => {
        const inputStyle = "w-full p-2 border border-slate-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition bg-slate-700 text-slate-200 placeholder:text-slate-400";
        const labelStyle = "block text-sm font-medium text-slate-300 mb-1 print:text-slate-700";

        return (
          <div className="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 mb-6 p-4 border border-slate-700 bg-slate-900/50 rounded-lg">
            <div>
              <label htmlFor="schoolName" className={labelStyle}>학교명</label>
              <input type="text" id="schoolName" value={schoolName} onChange={(e) => setSchoolName(e.target.value)} placeholder="예: AI 고등학교" className={inputStyle} />
            </div>
             <div>
              <label htmlFor="subjectName" className={labelStyle}>과목명</label>
              <input type="text" id="subjectName" value={subjectName} onChange={(e) => setSubjectName(e.target.value)} placeholder="예: 국어" className={inputStyle} />
            </div>
            <div className="grid grid-cols-3 gap-4 md:col-span-2">
              <div>
                  <label htmlFor="academicYear" className={labelStyle}>학년도</label>
                  <input type="number" id="academicYear" value={academicYear} onChange={(e) => setAcademicYear(parseInt(e.target.value, 10))} className={inputStyle} />
              </div>
              <div>
                  <label htmlFor="semester" className={labelStyle}>학기</label>
                  <select id="semester" value={semester} onChange={(e) => setSemester(e.target.value)} className={inputStyle}>
                    <option>1학기</option> <option>2학기</option>
                  </select>
              </div>
              <div>
                  <label htmlFor="examType" className={labelStyle}>고사명</label>
                  <select id="examType" value={examType} onChange={(e) => setExamType(e.target.value)} className={inputStyle} >
                    <option>중간고사</option> <option>기말고사</option>
                  </select>
              </div>
            </div>
          </div>
        );
      };

      const AnalysisDisplay = ({ id, markdownText, logoUrl, examInfo }) => {
        const { academicYear, semester, examType, subjectName } = examInfo;
        
        const renderContent = (content) => {
            return content.split('\n').map((line, index) => {
                if (!line.trim()) return null;
                line = line.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                line = line.replace(/\*(.*?)\*/g, '<em>$1</em>');
                return <p key={index} className="text-slate-300 print:text-slate-700 mt-2" dangerouslySetInnerHTML={{ __html: line }} />;
            }).filter(Boolean);
        };
        
        const Card = ({ title, content }) => {
            return (
                <div className="mb-8 p-6 bg-slate-800/50 rounded-lg shadow-md print:bg-white print:shadow-none print:border print:border-slate-200 analysis-card">
                    <h3 className="text-2xl font-bold text-blue-400 print:text-blue-800 pb-3 mb-4 border-b border-slate-700 print:border-slate-200" dangerouslySetInnerHTML={{ __html: title }}></h3>
                    <div className="space-y-4">
                        {content.map((section, idx) => {
                            const lines = section.trim().split('\n');
                            const sectionTitle = lines.shift() || '';
                            const sectionContent = lines.join('\n');
                            
                            return (
                                <div key={idx}>
                                     <h4 className="text-lg font-semibold text-slate-200 print:text-slate-700 mb-2" dangerouslySetInnerHTML={{ __html: sectionTitle }}></h4>
                                     <div className="pl-4 border-l-4 border-blue-500/30 print:border-blue-300">
                                        {renderContent(sectionContent)}
                                     </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const cards = markdownText.split('## ').filter(text => text.trim() !== '');

        return (
          <div id={id} className="print:shadow-none print:border-none print:p-0">
              <header className="relative mb-8 pb-4 border-b-2 border-slate-700 print:border-slate-200">
                  {logoUrl && (
                      <img src={logoUrl} alt="School Logo" className="absolute -top-4 right-0 w-24 h-auto object-contain" />
                  )}
                  <h2 className="text-3xl font-bold text-center text-slate-100 print:text-slate-800 pt-4">
                      {`${academicYear}학년도 ${semester} ${examType} ${subjectName} 문항 분석`}
                  </h2>
              </header>

              <div className="space-y-8">
              {cards.map((cardText, index) => {
                  const lines = cardText.trim().split('\n');
                  const title = lines.shift() || '분석';
                  const content = lines.join('\n').split('### ').filter(c => c.trim());
                  return <Card key={index} title={title} content={content} />;
              })}
              </div>
          </div>
        );
      };


      // --- Main App Component ---
      const App = () => {
        const [file, setFile] = React.useState(null);
        const [analysisResult, setAnalysisResult] = React.useState(null);
        const [isLoading, setIsLoading] = React.useState(false);
        const [error, setError] = React.useState(null);
        const [logoUrl, setLogoUrl] = React.useState(null);
        const logoInputRef = React.useRef(null);

        // Exam Info State
        const [schoolName, setSchoolName] = React.useState('');
        const [academicYear, setAcademicYear] = React.useState(new Date().getFullYear());
        const [semester, setSemester] = React.useState('1학기');
        const [examType, setExamType] = React.useState('중간고사');
        const [subjectName, setSubjectName] = React.useState('');

        React.useEffect(() => {
          const savedLogo = localStorage.getItem('schoolLogo');
          if (savedLogo) {
            setLogoUrl(savedLogo);
          }
        }, []);

        const handleFileChange = React.useCallback((selectedFile) => {
          if (!selectedFile) {
              setFile(null);
              return;
          }

          const isTxt = selectedFile.type === 'text/plain' || selectedFile.name.endsWith('.txt');
          const isPdf = selectedFile.type === 'application/pdf' || selectedFile.name.endsWith('.pdf');

          if (!isTxt && !isPdf) {
            setError('텍스트(.txt) 또는 PDF(.pdf) 파일만 업로드할 수 있습니다.');
            setFile(null);
            return;
          }
          
          setFile(selectedFile);
          setAnalysisResult(null);
          setError(null);
        }, []);

        const handleAnalyze = async () => {
          if (!file) {
            setError('분석할 파일을 먼저 선택해주세요.');
            return;
          }
          if (!genAI) {
            setError("API 키가 설정되지 않았습니다. HTML 파일 상단의 API_KEY를 실제 키로 교체해주세요.");
            return;
          }
          setIsLoading(true);
          setError(null);
          setAnalysisResult(''); 

          try {
            const stream = await analyzeExamStream(file);
            for await (const chunk of stream) {
              const chunkText = chunk.text();
              setAnalysisResult((prevResult) => prevResult + chunkText);
            }
          } catch (e) {
            console.error(e);
            let errorMessage = '분석 중 오류가 발생했습니다. 잠시 후 다시 시도해주세요.';
            if (e instanceof Error) {
              errorMessage = e.message;
            }
            setError(errorMessage);
            setAnalysisResult(null);
          } finally {
            setIsLoading(false);
          }
        };

        const handleReset = () => {
          setFile(null);
          setAnalysisResult(null);
          setError(null);
          setIsLoading(false);
        };

        const handleLogoUpload = (event) => {
          const file = event.target.files?.[0];
          if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onloadend = () => {
              const base64String = reader.result;
              localStorage.setItem('schoolLogo', base64String);
              setLogoUrl(base64String);
            };
            reader.readAsDataURL(file);
          } else {
              alert('이미지 파일만 업로드할 수 있습니다.');
          }
        };

        const handleLogoRemove = () => {
          localStorage.removeItem('schoolLogo');
          setLogoUrl(null);
        };
        
        const handleLogoClick = () => {
          logoInputRef.current?.click();
        };

        const handlePrint = () => {
          const reportElement = document.getElementById('analysis-report');
          if (!reportElement) {
            setError("인쇄할 분석 보고서를 찾을 수 없습니다.");
            return;
          }

          const printContent = reportElement.innerHTML;
          const tailwindScript = '<script src="https://cdn.tailwindcss.com"><\/script>';
          const printWindow = window.open('', '_blank');
          if (!printWindow) {
            setError("팝업이 차단되어 인쇄 창을 열 수 없습니다. 브라우저의 팝업 차단 설정을 확인해주세요.");
            return;
          }
          
          printWindow.document.write(`
            <html>
              <head>
                <title>문항 분석 보고서 인쇄</title>
                ${tailwindScript}
                <style>
                  body { font-family: 'Noto Sans KR', Arial, sans-serif; }
                   @media print {
                      @page { size: A4 portrait; margin: 1.5cm; }
                      .analysis-card { page-break-inside: avoid !important; }
                   }
                </style>
              </head>
              <body>${printContent}</body>
            </html>
          `);
          
          printWindow.document.close();
          setTimeout(() => {
              printWindow.focus();
              printWindow.print();
              printWindow.close();
          }, 500); 
        };
        
        const handleSaveAnalysis = () => {
          if (!analysisResult) {
            setError("저장할 분석 결과가 없습니다.");
            return;
          }
          const filename = `${academicYear}학년도_${schoolName}_${subjectName}_${semester}_${examType}_분석결과.md`;
          const blob = new Blob([analysisResult], { type: 'text/markdown;charset=utf-8;' });
          const link = document.createElement("a");
          const url = URL.createObjectURL(blob);
          link.setAttribute("href", url);
          link.setAttribute("download", filename);
          link.style.visibility = 'hidden';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
        };

        const isAnalysisReady = !!file && !!schoolName && !!subjectName;

        return (
          <div className="min-h-screen font-sans text-slate-300 flex items-center justify-center p-4 sm:p-6 md:p-8 print:p-0 print:block">
            <div className="w-full max-w-7xl bg-slate-800 rounded-2xl shadow-xl overflow-hidden print:shadow-none print:rounded-none print:bg-white print:text-slate-800">
              <div className="print:hidden">
                <Header />
              </div>
              <main className="p-6 md:p-8 print:p-0">
                {analysisResult === null ? (
                  <div>
                      <h2 className="text-2xl font-bold text-blue-400 mb-2 print:text-blue-800">분석 정보 입력</h2>
                      <p className="text-slate-400 mb-6 print:text-slate-600">시험 정보를 입력하고, 분석할 시험지 파일(.txt 또는 .pdf)을 업로드하세요.</p>
                      
                      <ExamInfoForm 
                        schoolName={schoolName} setSchoolName={setSchoolName}
                        academicYear={academicYear} setAcademicYear={setAcademicYear}
                        semester={semester} setSemester={setSemester}
                        examType={examType} setExamType={setExamType}
                        subjectName={subjectName} setSubjectName={setSubjectName}
                      />

                      <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                        <div>
                          <label className="block text-sm font-medium text-slate-300 mb-2 print:text-slate-700">학교 로고 (선택 사항)</label>
                          <div className="flex items-center">
                            <input type="file" ref={logoInputRef} onChange={handleLogoUpload} className="hidden" accept="image/*" />
                            {logoUrl ? (
                              <div className="group relative">
                                <img src={logoUrl} alt="School Logo" className="h-16 max-w-32 object-contain border rounded-md p-1 bg-white shadow-sm" />
                                <button onClick={handleLogoRemove} className="absolute top-0 right-0 -mt-2 -mr-2 bg-slate-900 text-slate-300 hover:bg-slate-700 rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity" aria-label="Remove logo" >
                                  <XCircleIcon className="h-5 w-5" />
                                </button>
                              </div>
                            ) : (
                              <button onClick={handleLogoClick} className="flex items-center gap-2 border-2 border-dashed border-slate-600 rounded-lg px-4 py-2 text-blue-400 hover:bg-slate-700 hover:border-blue-500 transition-all" aria-label="Upload logo">
                                <PlusCircleIcon className="h-5 w-5" />
                                <span>로고 추가</span>
                              </button>
                            )}
                          </div>
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-slate-300 mb-2 print:text-slate-700">시험지 파일</label>
                          <FileUpload onFileChange={handleFileChange} />
                        </div>
                      </div>

                      {file && (
                        <div className="mt-6 p-4 bg-slate-700 border border-slate-600 rounded-lg flex items-center justify-between">
                          <div className="flex items-center gap-3">
                            <FileTextIcon className="h-6 w-6 text-blue-400" />
                            <span className="font-medium text-slate-100">{file.name}</span>
                          </div>
                          <button onClick={() => handleFileChange(null)} className="text-slate-400 hover:text-slate-200 text-2xl leading-none">&times;</button>
                        </div>
                      )}

                      <div className="mt-8 text-center">
                        <button onClick={handleAnalyze} disabled={!isAnalysisReady || isLoading} className="inline-flex items-center gap-2 bg-blue-500 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:bg-blue-600 disabled:bg-slate-700 disabled:text-slate-500 disabled:cursor-not-allowed transition-all duration-300 transform hover:scale-105" >
                          <BrainCircuitIcon className="h-5 w-5" />
                          분석 실행
                        </button>
                      </div>
                  </div>
                ) : (
                   <div>
                    <div className="mb-6 flex justify-end gap-4 print:hidden">
                      <button onClick={handleSaveAnalysis} disabled={isLoading} className="inline-flex items-center gap-2 bg-blue-500 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-blue-600 transition-colors disabled:bg-slate-700 disabled:cursor-not-allowed" >
                          <DownloadIcon className="h-5 w-5" /> 결과 저장
                      </button>
                      <button onClick={handlePrint} disabled={isLoading} className="inline-flex items-center gap-2 bg-emerald-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-emerald-700 transition-colors disabled:bg-slate-700 disabled:cursor-not-allowed">
                          <PrintIcon className="h-5 w-5" /> 결과 인쇄
                      </button>
                      <button onClick={handleReset} disabled={isLoading} className="bg-slate-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-slate-700 transition-colors disabled:bg-slate-700 disabled:cursor-not-allowed" >
                          새로운 분석 시작
                      </button>
                    </div>
                    
                    {isLoading && analysisResult.length === 0 && <Loader />}
                    
                    <AnalysisDisplay 
                      id="analysis-report"
                      markdownText={analysisResult}
                      logoUrl={logoUrl}
                      examInfo={{ academicYear, semester, examType, subjectName }}
                    />
                  </div>
                )}

                {error && (
                  <div className="bg-red-500/10 border border-red-500/30 text-red-400 px-4 py-3 rounded-lg relative my-4" role="alert">
                    <strong className="font-bold">오류: </strong>
                    <span className="block sm:inline">{error}</span>
                  </div>
                )}
              </main>
              <footer className="text-center py-4 text-slate-400 text-sm border-t border-slate-700 print:hidden">
                <p>Powered by Question Analysis Pro & Google Gemini</p>
              </footer>
            </div>
          </div>
        );
      };

      const container = document.getElementById('root');
      const root = ReactDOM.createRoot(container);
      root.render(<App />);
    </script>
</body>
</html>
