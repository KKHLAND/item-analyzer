<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Question Analysis Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="importmap">
    {
      "imports": {
        "@google/generative-ai": "https://esm.run/@google/generative-ai"
      }
    }
    </script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&family=Arial:wght@400;700&display=swap');
      body {
        font-family: 'Noto Sans KR', Arial, sans-serif;
      }
      @media print {
        @page {
          size: A4 portrait;
          margin: 1.5cm;
        }
        .analysis-card {
          page-break-inside: avoid;
        }
      }
    </style>
</head>
<body class="bg-slate-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
      import { GoogleGenerativeAI } from "@google/generative-ai";

      const API_KEY = "AIzaSyCAN3CHVuwJsS94wT-BsmD7HNad78jBVlc";

      // --- Constants ---
      const PROMPT_TEMPLATE = `
        Persona
        ë‹¹ì‹ ì€ 'ë¬¸í•­ ë¶„ì„ í”„ë¡œ(Question Analysis Pro)'ë¼ëŠ” ì´ë¦„ì„ ê°€ì§„, ê³ ë“±í•™êµ ì‹œí—˜ ë¬¸í•­ ë¶„ì„ì„ ìœ„í•œ ìµœê³ ì˜ AI ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë‹¹ì‹ ì€ êµìœ¡ í‰ê°€, êµê³¼ê³¼ì •, êµ­ì–´ ì–´ë¬¸ ê·œë²”ì— ëŒ€í•œ ê¹Šì´ ìˆëŠ” ì§€ì‹ì„ ê°–ì¶”ê³  ìˆìœ¼ë©°, ì¶œì œìì˜ ì˜ë„ë¥¼ ì¡´ì¤‘í•˜ë©´ì„œë„ ê±´ì„¤ì ì¸ í”¼ë“œë°±ì„ ì œê³µí•˜ëŠ” ë° ëŠ¥ìˆ™í•©ë‹ˆë‹¤. ë‹¹ì‹ ì˜ ë¶„ì„ì€ í•­ìƒ ëª…í™•í•˜ê³ , ì²´ê³„ì ì´ë©°, ì‹œê°ì ìœ¼ë¡œ ì´í•´í•˜ê¸° ì‰¬ìš´ 'ì¹´ë“œ(Card)' í˜•ì‹ìœ¼ë¡œ ì œê³µë©ë‹ˆë‹¤.

        Context
        ê³ ë“±í•™êµ ì„ ìƒë‹˜ì¸ ì‚¬ìš©ìê°€ ìì‹ ì´ ì¶œì œí•œ ì •ê¸°ê³ ì‚¬(ì¤‘ê°„ê³ ì‚¬ ë˜ëŠ” ê¸°ë§ê³ ì‚¬) í…ìŠ¤íŠ¸ íŒŒì¼ì„ ì—…ë¡œë“œí•©ë‹ˆë‹¤. ë‹¹ì‹ ì˜ ì„ë¬´ëŠ” ì´ ì‹œí—˜ì§€ë¥¼ ë¬¸í•­ë³„ë¡œ ì‹¬ì¸µ ë¶„ì„í•˜ê³ , ê·¸ ê²°ê³¼ë¥¼ ì•„ë˜ì— ì •ì˜ëœ 'ë¶„ì„ ì¹´ë“œ' í˜•ì‹ì— ë§ì¶° ìƒì„±í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ìµœì¢… ëª©í‘œëŠ” ì„ ìƒë‹˜ì´ ë¬¸í•­ì˜ ì§ˆì„ ë†’ì´ê³ , í•™ìƒë“¤ì˜ í•™ì—… ì„±ì·¨ë„ë¥¼ ë” ì •í™•í•˜ê²Œ í‰ê°€í•  ìˆ˜ ìˆë„ë¡ ë•ëŠ” ê²ƒì…ë‹ˆë‹¤.

        Input Variable
        {{exam_text}}: ì‚¬ìš©ìê°€ ì—…ë¡œë“œí•œ ì‹œí—˜ì§€ ì „ì²´ í…ìŠ¤íŠ¸ì…ë‹ˆë‹¤. ë¬¸í•­ ë²ˆí˜¸, ë¬¸ì œ, ë³´ê¸°, ë°°ì  ë“±ì˜ ì •ë³´ê°€ í¬í•¨ë©ë‹ˆë‹¤.

        Instructions
        {{exam_text}}ë¥¼ ê¸°ë°˜ìœ¼ë¡œ, ë‹¤ìŒ ê·œì¹™ì— ë”°ë¼ ë¬¸í•­ ë¶„ì„ ê²°ê³¼ë¥¼ ìƒì„±í•˜ì„¸ìš”. ëª¨ë“  ì„¤ëª…ê³¼ ë¶„ì„ì€ í•µì‹¬ ìœ„ì£¼ë¡œ ê°„ê²°í•˜ê²Œ ì‘ì„±í•©ë‹ˆë‹¤.

        1. ì „ì²´ êµ¬ì¡°:
        ë¶„ì„ì€ í¬ê²Œ <ë¬¸í•­ë³„ ê°œë³„ ë¶„ì„>ê³¼ <ì´í‰ ë° ì œì–¸> ë‘ ë¶€ë¶„ìœ¼ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤.
        ëª¨ë“  ê²°ê³¼ë¬¼ì€ Markdownì„ ì‚¬ìš©í•˜ì—¬ ëª…í™•í•˜ê³  ì„¸ë ¨ëœ ì¹´ë“œ í˜•ì‹ìœ¼ë¡œ ë””ìì¸í•©ë‹ˆë‹¤. ì´ëª¨ì§€ë¥¼ ì ì ˆíˆ í™œìš©í•˜ì—¬ ê°€ë…ì„±ì„ ë†’ì—¬ì£¼ì„¸ìš”.

        2. ë¬¸í•­ë³„ ê°œë³„ ë¶„ì„ (Analysis Card):
        ê° ë¬¸í•­ì— ëŒ€í•´ ì•„ë˜ í…œí”Œë¦¿ì— ë§ì¶° í•˜ë‚˜ì˜ 'ë¶„ì„ ì¹´ë“œ'ë¥¼ ìƒì„±í•˜ì„¸ìš”.

        ## ğŸ“Œ ë¬¸í•­ [ë²ˆí˜¸] ë¶„ì„
        ### âœ… ì •ë‹µ ë° í•´ì„¤
        ì •ë‹µ: (ì—¬ê¸°ì— ëª…í™•í•œ ì •ë‹µì„ ê¸°ì¬í•˜ì„¸ìš”. ì˜ˆ: â‘¢)
        í•µì‹¬ ê°œë…: (ì´ ë¬¸í•­ì´ í‰ê°€í•˜ê³ ì í•˜ëŠ” í•µì‹¬ ê°œë…ì´ë‚˜ ì§€ì‹ì„ ê°„ëµíˆ ì„œìˆ í•˜ì„¸ìš”.)
        ìƒì„¸ í•´ì„¤: (ì •ë‹µì¸ ì´ìœ ì™€ ì˜¤ë‹µì¸ ì´ìœ ë¥¼ ê°„ê²°í•˜ê²Œ ì„¤ëª…í•©ë‹ˆë‹¤.)

        ### ğŸ§ ë¬¸í•­ í”¼ë“œë°± (ê°„ê²°í•˜ê²Œ í•µì‹¬ë§Œ ìš”ì•½)
        âœï¸ ì² ì ë° ì–´ë²•: (ì² ì, ë„ì–´ì“°ê¸°, ë¬¸ë²•ì  ì˜¤ë¥˜(ë¹„ë¬¸) ë“±ì„ ê²€í† í•©ë‹ˆë‹¤. ì˜¤ë¥˜ê°€ ì—†ë‹¤ë©´ 'ì˜¤ë¥˜ ì—†ìŒ'ìœ¼ë¡œ, ìˆë‹¤ë©´ 'ìˆ˜ì • ì œì•ˆ: "ì›ë³¸" â†’ "ìˆ˜ì •ë³¸"' í˜•ì‹ìœ¼ë¡œ ì œì‹œí•˜ì„¸ìš”.)
        âš ï¸ ë¬¸í•­ ì˜¤ë¥˜ ê°€ëŠ¥ì„±: (ì‚¬ì‹¤ ê´€ê³„ ì˜¤ë¥˜, ë³µìˆ˜ ì •ë‹µ ê°€ëŠ¥ì„±, ì •ë‹µ ì—†ìŒ, ì§€ë¬¸/ë³´ê¸°ì˜ ë…¼ë¦¬ì  ëª¨ìˆœ ë“± ë¬¸í•­ ìì²´ì˜ ì ì¬ì  ì˜¤ë¥˜ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤. ë¬¸ì œê°€ ì—†ë‹¤ë©´ 'ì˜¤ë¥˜ ê°€ëŠ¥ì„± ë‚®ìŒ'ìœ¼ë¡œ, ìˆë‹¤ë©´ êµ¬ì²´ì ì¸ ì´ìœ ì™€ ê·¼ê±°ë¥¼ ì œì‹œí•˜ì„¸ìš”.)
        ğŸ¯ ë¬¸í•­ ì ì ˆì„±: (êµìœ¡ê³¼ì • ì„±ì·¨ ê¸°ì¤€ê³¼ì˜ ë¶€í•©ë„, ë‚œì´ë„(ìƒ/ì¤‘/í•˜), ë°œë¬¸ì˜ ëª…í™•ì„±, ë³´ê¸°ì˜ ë§¤ë ¥ë„ ë“±ì„ ì¢…í•©ì ìœ¼ë¡œ í‰ê°€í•©ë‹ˆë‹¤. 'ì ì ˆí•¨', 'ê°œì„  ì œì•ˆ' ë“±ìœ¼ë¡œ í‰ê°€í•˜ê³  ì´ìœ ë¥¼ ê°„ëµíˆ ë§ë¶™ì´ì„¸ìš”.)
        âš–ï¸ ì˜ˆìƒ ë³€ë³„ë ¥: (í•´ë‹¹ ë¬¸í•­ì´ ìƒìœ„ê¶Œ, ì¤‘ìœ„ê¶Œ, í•˜ìœ„ê¶Œ í•™ìƒì„ êµ¬ë³„í•´ë‚¼ ìˆ˜ ìˆëŠ” ì •ë„ë¥¼ 'ìƒ/ì¤‘/í•˜'ë¡œ í‰ê°€í•˜ê³ , ê·¸ ì´ìœ ë¥¼ ì„¤ëª…í•©ë‹ˆë‹¤. ì˜ˆ: 'ìƒ - í•µì‹¬ ê°œë…ì„ ì •í™•íˆ ì´í•´í•˜ê³  í•¨ì • ë³´ê¸°ë¥¼ í”¼í•´ì•¼ í•˜ë¯€ë¡œ ë³€ë³„ë ¥ ë†’ìŒ')

        3. ì´í‰ ë° ì œì–¸ (Overall Feedback Card):
        ëª¨ë“  ê°œë³„ ë¬¸í•­ ë¶„ì„ì´ ëë‚œ í›„, ì‹œí—˜ ì „ì²´ì— ëŒ€í•œ ì¢…í•©ì ì¸ í”¼ë“œë°± ì¹´ë“œë¥¼ ì•„ë˜ í…œí”Œë¦¿ì— ë§ì¶° ìƒì„±í•˜ì„¸ìš”.

        ## ğŸ“‹ ì´í‰ ë° ì œì–¸ (ê°„ê²°í•˜ê²Œ í•µì‹¬ë§Œ ìš”ì•½)
        ### ğŸ‘ ê°•ì  (Strengths)
        (ì‹œí—˜ ì „ë°˜ì— ê±¸ì³ ì˜ëœ ì ì„ 2-3ê°€ì§€ êµ¬ì²´ì ìœ¼ë¡œ ì¹­ì°¬í•©ë‹ˆë‹¤. ì˜ˆ: êµìœ¡ê³¼ì •ì˜ í•µì‹¬ ìš”ì†Œë¥¼ ì¶©ì‹¤íˆ ë°˜ì˜í•¨, ë‹¤ì–‘í•œ ìœ í˜•ì˜ ë¬¸í•­ì„ ê· í˜• ìˆê²Œ ì¶œì œí•¨ ë“±)

        ### ğŸ’¡ ê°œì„  ì œì•ˆ (Suggestions for Improvement)
        (ì‹œí—˜ì˜ ì™„ì„±ë„ë¥¼ ë”ìš± ë†’ì´ê¸° ìœ„í•œ ê±´ì„¤ì ì¸ ì œì•ˆì„ 2-3ê°€ì§€ ì œì‹œí•©ë‹ˆë‹¤. ì˜ˆ: ì¼ë¶€ ë¹„ë¬¸ ìˆ˜ì • ì œì•ˆ, ê³ ë‚œë„ ë¬¸í•­ì˜ ë°œë¬¸ ëª…í™•í™”, íŠ¹ì • ìœ í˜• ë¬¸í•­ì˜ ë¹„ì¤‘ ì¡°ì ˆ ë“±)

        ### ğŸ“Š ì „ì²´ ë‚œì´ë„ ë° ë³€ë³„ë ¥ ë¶„ì„
        ì „ì²´ ë‚œì´ë„: (ì‹œí—˜ì˜ ì „ë°˜ì ì¸ ì²´ê° ë‚œì´ë„ë¥¼ 'ìƒ/ì¤‘/í•˜'ë¡œ í‰ê°€í•˜ê³ , ê·¸ ê·¼ê±°ë¥¼ ì œì‹œí•©ë‹ˆë‹¤.)
        ë³€ë³„ë ¥ í™•ë³´: (ì „ì²´ ì‹œí—˜ì´ í•™ìƒë“¤ì˜ ì„±ì·¨ ìˆ˜ì¤€ì„ íš¨ê³¼ì ìœ¼ë¡œ ë³€ë³„í•  ìˆ˜ ìˆì„ì§€ì— ëŒ€í•œ ì¢…í•©ì ì¸ ì˜ê²¬ì„ ì œì‹œí•©ë‹ˆë‹¤. íŠ¹íˆ ë³€ë³„ë ¥ì„ ê°€ë¥¼ ê²ƒìœ¼ë¡œ ì˜ˆìƒë˜ëŠ” 'í‚¬ëŸ¬ ë¬¸í•­'ì„ ì–¸ê¸‰í•˜ë©´ ì¢‹ìŠµë‹ˆë‹¤.)

        ì‹œí—˜ì§€ í…ìŠ¤íŠ¸:
        \`\`\`
        {{exam_text}}
        \`\`\`
        `;

      // --- Gemini Service ---
      let genAI;
      try {
        if (!API_KEY || API_KEY === "YOUR_API_KEY") {
            throw new Error("API_KEY is not set. Please replace 'YOUR_API_KEY' in the HTML file.");
        }
        genAI = new GoogleGenerativeAI(API_KEY);
      } catch (e) {
        console.error(e);
      }


      const fileToGenerativePart = async (file) => {
          const base64EncodedData = await new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onloadend = () => {
                  if (typeof reader.result === 'string') {
                      resolve(reader.result.split(',')[1]);
                  } else {
                      reject(new Error("Failed to read file as data URL"));
                  }
              };
              reader.onerror = (err) => reject(err);
              reader.readAsDataURL(file);
          });

          return {
              inlineData: {
                  data: base64EncodedData,
                  mimeType: file.type,
              },
          };
      };

      const readTextFromFile = (file) => {
          return new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = (e) => {
                  if (e.target?.result) {
                      resolve(e.target.result);
                  } else {
                      reject(new Error("Failed to read text from file."));
                  }
              };
              reader.onerror = (err) => reject(err);
              reader.readAsText(file, 'UTF-8');
          });
      };

      const analyzeExamStream = async (examFile) => {
        try {
          if (!genAI) {
            throw new Error("Gemini AI client is not initialized. Check your API key.");
          }
          const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
          const isTxt = examFile.type === 'text/plain' || examFile.name.endsWith('.txt');

          if (isTxt) {
              const examText = await readTextFromFile(examFile);
              const prompt = PROMPT_TEMPLATE.replace('{{exam_text}}', examText);
              const result = await model.generateContentStream(prompt);
              return result.stream;
          } else { // PDF file
              const filePart = await fileToGenerativePart(examFile);
              const promptForFile = PROMPT_TEMPLATE.replace(/ì‹œí—˜ì§€ í…ìŠ¤íŠ¸:\s*```\s*{{exam_text}}\s*```/g, '').trim();

              const result = await model.generateContentStream([promptForFile, filePart]);
              return result.stream;
          }
        } catch (error) {
          console.error("Error calling Gemini API:", error);
          if (error.message.includes('API key not valid')) {
             throw new Error("Gemini API í‚¤ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. HTML íŒŒì¼ì˜ API_KEYë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
          }
          throw new Error("Gemini APIì—ì„œ ë¶„ì„ ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      };


      // --- Icons ---
      const BookCheckIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/>
          <path d="m9 9.5 2 2 4-4"/>
        </svg>
      );

      const UploadCloudIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/>
          <path d="M12 12v9"/>
          <path d="m16 16-4-4-4 4"/>
        </svg>
      );

      const FileTextIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/>
          <path d="M14 2v4a2 2 0 0 0 2 2h4"/>
          <path d="M16 13H8"/>
          <path d="M16 17H8"/>
          <path d="M10 9H8"/>
        </svg>
      );

      const BrainCircuitIcon = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
              <path d="M12 5a3 3 0 1 0-5.993.142"/><path d="M18 13a3 3 0 1 0-3-5.196"/>
              <path d="M12 19a3 3 0 1 0 5.993-.142"/><path d="M6 13a3 3 0 1 0 3 5.196"/>
              <path d="M12 12v.142a3 3 0 1 1-3 5.196"/><path d="M12 12v-.142a3 3 0 1 0 3-5.196"/>
              <path d="m14.5 7.5 1 1"/><path d="m9.5 7.5-1 1"/><path d="m14.5 16.5-1-1"/>
              <path d="m9.5 16.5 1-1"/><path d="M12 8v-3"/><path d="M12 22v-3"/>
              <path d="M19 12h3"/><path d="M2 12h3"/>
          </svg>
      );

      const PlusCircleIcon = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
              <circle cx="12" cy="12" r="10" /><line x1="12" y1="8" x2="12" y2="16" />
              <line x1="8" y1="12" x2="16" y2="12" />
          </svg>
      );

      const XCircleIcon = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
              <circle cx="12" cy="12" r="10" /><line x1="15" y1="9" x2="9" y2="15" />
              <line x1="9" y1="9" x2="15" y2="15" />
          </svg>
      );

      const PrintIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <polyline points="6 9 6 2 18 2 18 9" />
          <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" />
          <rect x="6" y="14" width="12" height="8" />
        </svg>
      );

      const DownloadIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
      );


      // --- Components ---
      const Header = () => {
        return (
          <header className="p-6 md:p-8 bg-gradient-to-r from-indigo-700 to-purple-600">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-4">
                <div className="bg-cyan-400/20 p-3 rounded-full">
                  <BookCheckIcon className="h-8 w-8 text-cyan-300" />
                </div>
                <div>
                  <h1 className="text-3xl font-bold text-slate-100">
                    ë¬¸í•­ ë¶„ì„ í”„ë¡œ
                  </h1>
                  <p className="text-cyan-300 mt-1">AI ê¸°ë°˜ ë¬¸í•­ ì‹¬ì¸µ ë¶„ì„</p>
                </div>
              </div>
            </div>
          </header>
        );
      };

      const FileUpload = ({ onFileChange }) => {
        const fileInputRef = React.useRef(null);

        const handleFileChange = (event) => {
          const file = event.target.files?.[0];
          if (file) {
            onFileChange(file);
          }
        };

        const handleAreaClick = () => {
          fileInputRef.current?.click();
        };
        
        const handleDragOver = (event) => {
          event.preventDefault();
        };

        const handleDrop = (event) => {
          event.preventDefault();
          const file = event.dataTransfer.files?.[0];
          if (file) {
            onFileChange(file);
          }
        };

        return (
          <div
            onClick={handleAreaClick}
            onDragOver={handleDragOver}
            onDrop={handleDrop}
            className="border-2 border-dashed border-slate-600 rounded-xl p-8 text-center transition-colors bg-slate-800/50 hover:bg-slate-700/70 hover:border-slate-500 cursor-pointer"
          >
            <input
              type="file"
              ref={fileInputRef}
              onChange={handleFileChange}
              className="hidden"
              accept=".txt,text/plain,.pdf,application/pdf"
            />
            <div className="flex flex-col items-center justify-center">
                <>
                  <UploadCloudIcon className="h-12 w-12 text-blue-400 mb-4" />
                  <p className="text-lg font-semibold text-blue-300">íŒŒì¼ì„ ë“œë˜ê·¸ ì•¤ ë“œë¡­í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
                  <p className="text-sm text-slate-400 mt-1">(.txt ë˜ëŠ” .pdf íŒŒì¼ í˜•ì‹ë§Œ ì§€ì›)</p>
                </>
            </div>
          </div>
        );
      };
      
      const Loader = () => {
        return (
          <div className="flex flex-col items-center justify-center p-12">
            <svg className="animate-spin h-12 w-12 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
              <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p className="mt-4 text-lg font-semibold text-blue-300">AIê°€ ë¬¸í•­ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
            <p className="text-slate-400">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
          </div>
        );
      };

      const ExamInfoForm = ({
        schoolName, setSchoolName,
        academicYear, setAcademicYear,
        semester, setSemester,
        examType, setExamType,
        subjectName, setSubjectName
      }) => {
        const inputStyle = "w-full p-2 border border-slate-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition bg-slate-700 text-slate-200 placeholder:text-slate-400";
        const labelStyle = "block text-sm font-medium text-slate-300 mb-1 print:text-slate-700";

        return (
          <div className="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 mb-6 p-4 border border-slate-700 bg-slate-900/50 rounded-lg">
            <div>
              <label htmlFor="schoolName" className={labelStyle}>í•™êµëª…</label>
              <input type="text" id="schoolName" value={schoolName} onChange={(e) => setSchoolName(e.target.value)} placeholder="ì˜ˆ: AI ê³ ë“±í•™êµ" className={inputStyle} />
            </div>
             <div>
              <label htmlFor="subjectName" className={labelStyle}>ê³¼ëª©ëª…</label>
              <input type="text" id="subjectName" value={subjectName} onChange={(e) => setSubjectName(e.target.value)} placeholder="ì˜ˆ: êµ­ì–´" className={inputStyle} />
            </div>
            <div className="grid grid-cols-3 gap-4 md:col-span-2">
              <div>
                  <label htmlFor="academicYear" className={labelStyle}>í•™ë…„ë„</label>
                  <input type="number" id="academicYear" value={academicYear} onChange={(e) => setAcademicYear(parseInt(e.target.value, 10))} className={inputStyle} />
              </div>
              <div>
                  <label htmlFor="semester" className={labelStyle}>í•™ê¸°</label>
                  <select id="semester" value={semester} onChange={(e) => setSemester(e.target.value)} className={inputStyle}>
                    <option>1í•™ê¸°</option> <option>2í•™ê¸°</option>
                  </select>
              </div>
              <div>
                  <label htmlFor="examType" className={labelStyle}>ê³ ì‚¬ëª…</label>
                  <select id="examType" value={examType} onChange={(e) => setExamType(e.target.value)} className={inputStyle} >
                    <option>ì¤‘ê°„ê³ ì‚¬</option> <option>ê¸°ë§ê³ ì‚¬</option>
                  </select>
              </div>
            </div>
          </div>
        );
      };

      const AnalysisDisplay = ({ id, markdownText, logoUrl, examInfo }) => {
        const { academicYear, semester, examType, subjectName } = examInfo;
        
        const renderContent = (content) => {
            return content.split('\n').map((line, index) => {
                if (!line.trim()) return null;
                line = line.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                line = line.replace(/\*(.*?)\*/g, '<em>$1</em>');
                return <p key={index} className="text-slate-300 print:text-slate-700 mt-2" dangerouslySetInnerHTML={{ __html: line }} />;
            }).filter(Boolean);
        };
        
        const Card = ({ title, content }) => {
            return (
                <div className="mb-8 p-6 bg-slate-800/50 rounded-lg shadow-md print:bg-white print:shadow-none print:border print:border-slate-200 analysis-card">
                    <h3 className="text-2xl font-bold text-blue-400 print:text-blue-800 pb-3 mb-4 border-b border-slate-700 print:border-slate-200" dangerouslySetInnerHTML={{ __html: title }}></h3>
                    <div className="space-y-4">
                        {content.map((section, idx) => {
                            const lines = section.trim().split('\n');
                            const sectionTitle = lines.shift() || '';
                            const sectionContent = lines.join('\n');
                            
                            return (
                                <div key={idx}>
                                     <h4 className="text-lg font-semibold text-slate-200 print:text-slate-700 mb-2" dangerouslySetInnerHTML={{ __html: sectionTitle }}></h4>
                                     <div className="pl-4 border-l-4 border-blue-500/30 print:border-blue-300">
                                        {renderContent(sectionContent)}
                                     </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const cards = markdownText.split('## ').filter(text => text.trim() !== '');

        return (
          <div id={id} className="print:shadow-none print:border-none print:p-0">
              <header className="relative mb-8 pb-4 border-b-2 border-slate-700 print:border-slate-200">
                  {logoUrl && (
                      <img src={logoUrl} alt="School Logo" className="absolute -top-4 right-0 w-24 h-auto object-contain" />
                  )}
                  <h2 className="text-3xl font-bold text-center text-slate-100 print:text-slate-800 pt-4">
                      {`${academicYear}í•™ë…„ë„ ${semester} ${examType} ${subjectName} ë¬¸í•­ ë¶„ì„`}
                  </h2>
              </header>

              <div className="space-y-8">
              {cards.map((cardText, index) => {
                  const lines = cardText.trim().split('\n');
                  const title = lines.shift() || 'ë¶„ì„';
                  const content = lines.join('\n').split('### ').filter(c => c.trim());
                  return <Card key={index} title={title} content={content} />;
              })}
              </div>
          </div>
        );
      };


      // --- Main App Component ---
      const App = () => {
        const [file, setFile] = React.useState(null);
        const [analysisResult, setAnalysisResult] = React.useState(null);
        const [isLoading, setIsLoading] = React.useState(false);
        const [error, setError] = React.useState(null);
        const [logoUrl, setLogoUrl] = React.useState(null);
        const logoInputRef = React.useRef(null);

        // Exam Info State
        const [schoolName, setSchoolName] = React.useState('');
        const [academicYear, setAcademicYear] = React.useState(new Date().getFullYear());
        const [semester, setSemester] = React.useState('1í•™ê¸°');
        const [examType, setExamType] = React.useState('ì¤‘ê°„ê³ ì‚¬');
        const [subjectName, setSubjectName] = React.useState('');

        React.useEffect(() => {
          const savedLogo = localStorage.getItem('schoolLogo');
          if (savedLogo) {
            setLogoUrl(savedLogo);
          }
        }, []);

        const handleFileChange = React.useCallback((selectedFile) => {
          if (!selectedFile) {
              setFile(null);
              return;
          }

          const isTxt = selectedFile.type === 'text/plain' || selectedFile.name.endsWith('.txt');
          const isPdf = selectedFile.type === 'application/pdf' || selectedFile.name.endsWith('.pdf');

          if (!isTxt && !isPdf) {
            setError('í…ìŠ¤íŠ¸(.txt) ë˜ëŠ” PDF(.pdf) íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            setFile(null);
            return;
          }
          
          setFile(selectedFile);
          setAnalysisResult(null);
          setError(null);
        }, []);

        const handleAnalyze = async () => {
          if (!file) {
            setError('ë¶„ì„í•  íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
          }
          if (!genAI) {
            setError("API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. HTML íŒŒì¼ ìƒë‹¨ì˜ API_KEYë¥¼ ì‹¤ì œ í‚¤ë¡œ êµì²´í•´ì£¼ì„¸ìš”.");
            return;
          }
          setIsLoading(true);
          setError(null);
          setAnalysisResult(''); 

          try {
            const stream = await analyzeExamStream(file);
            for await (const chunk of stream) {
              const chunkText = chunk.text();
              setAnalysisResult((prevResult) => prevResult + chunkText);
            }
          } catch (e) {
            console.error(e);
            let errorMessage = 'ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
            if (e instanceof Error) {
              errorMessage = e.message;
            }
            setError(errorMessage);
            setAnalysisResult(null);
          } finally {
            setIsLoading(false);
          }
        };

        const handleReset = () => {
          setFile(null);
          setAnalysisResult(null);
          setError(null);
          setIsLoading(false);
        };

        const handleLogoUpload = (event) => {
          const file = event.target.files?.[0];
          if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onloadend = () => {
              const base64String = reader.result;
              localStorage.setItem('schoolLogo', base64String);
              setLogoUrl(base64String);
            };
            reader.readAsDataURL(file);
          } else {
              alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
          }
        };

        const handleLogoRemove = () => {
          localStorage.removeItem('schoolLogo');
          setLogoUrl(null);
        };
        
        const handleLogoClick = () => {
          logoInputRef.current?.click();
        };

        const handlePrint = () => {
          const reportElement = document.getElementById('analysis-report');
          if (!reportElement) {
            setError("ì¸ì‡„í•  ë¶„ì„ ë³´ê³ ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }

          const printContent = reportElement.innerHTML;
          const tailwindScript = '<script src="https://cdn.tailwindcss.com"><\/script>';
          const printWindow = window.open('', '_blank');
          if (!printWindow) {
            setError("íŒì—…ì´ ì°¨ë‹¨ë˜ì–´ ì¸ì‡„ ì°½ì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì €ì˜ íŒì—… ì°¨ë‹¨ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
            return;
          }
          
          printWindow.document.write(`
            <html>
              <head>
                <title>ë¬¸í•­ ë¶„ì„ ë³´ê³ ì„œ ì¸ì‡„</title>
                ${tailwindScript}
                <style>
                  body { font-family: 'Noto Sans KR', Arial, sans-serif; }
                   @media print {
                      @page { size: A4 portrait; margin: 1.5cm; }
                      .analysis-card { page-break-inside: avoid !important; }
                   }
                </style>
              </head>
              <body>${printContent}</body>
            </html>
          `);
          
          printWindow.document.close();
          setTimeout(() => {
              printWindow.focus();
              printWindow.print();
              printWindow.close();
          }, 500); 
        };
        
        const handleSaveAnalysis = () => {
          if (!analysisResult) {
            setError("ì €ì¥í•  ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }
          const filename = `${academicYear}í•™ë…„ë„_${schoolName}_${subjectName}_${semester}_${examType}_ë¶„ì„ê²°ê³¼.md`;
          const blob = new Blob([analysisResult], { type: 'text/markdown;charset=utf-8;' });
          const link = document.createElement("a");
          const url = URL.createObjectURL(blob);
          link.setAttribute("href", url);
          link.setAttribute("download", filename);
          link.style.visibility = 'hidden';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
        };

        const isAnalysisReady = !!file && !!schoolName && !!subjectName;

        return (
          <div className="min-h-screen font-sans text-slate-300 flex items-center justify-center p-4 sm:p-6 md:p-8 print:p-0 print:block">
            <div className="w-full max-w-7xl bg-slate-800 rounded-2xl shadow-xl overflow-hidden print:shadow-none print:rounded-none print:bg-white print:text-slate-800">
              <div className="print:hidden">
                <Header />
              </div>
              <main className="p-6 md:p-8 print:p-0">
                {analysisResult === null ? (
                  <div>
                      <h2 className="text-2xl font-bold text-blue-400 mb-2 print:text-blue-800">ë¶„ì„ ì •ë³´ ì…ë ¥</h2>
                      <p className="text-slate-400 mb-6 print:text-slate-600">ì‹œí—˜ ì •ë³´ë¥¼ ì…ë ¥í•˜ê³ , ë¶„ì„í•  ì‹œí—˜ì§€ íŒŒì¼(.txt ë˜ëŠ” .pdf)ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.</p>
                      
                      <ExamInfoForm 
                        schoolName={schoolName} setSchoolName={setSchoolName}
                        academicYear={academicYear} setAcademicYear={setAcademicYear}
                        semester={semester} setSemester={setSemester}
                        examType={examType} setExamType={setExamType}
                        subjectName={subjectName} setSubjectName={setSubjectName}
                      />

                      <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                        <div>
                          <label className="block text-sm font-medium text-slate-300 mb-2 print:text-slate-700">í•™êµ ë¡œê³  (ì„ íƒ ì‚¬í•­)</label>
                          <div className="flex items-center">
                            <input type="file" ref={logoInputRef} onChange={handleLogoUpload} className="hidden" accept="image/*" />
                            {logoUrl ? (
                              <div className="group relative">
                                <img src={logoUrl} alt="School Logo" className="h-16 max-w-32 object-contain border rounded-md p-1 bg-white shadow-sm" />
                                <button onClick={handleLogoRemove} className="absolute top-0 right-0 -mt-2 -mr-2 bg-slate-900 text-slate-300 hover:bg-slate-700 rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity" aria-label="Remove logo" >
                                  <XCircleIcon className="h-5 w-5" />
                                </button>
                              </div>
                            ) : (
                              <button onClick={handleLogoClick} className="flex items-center gap-2 border-2 border-dashed border-slate-600 rounded-lg px-4 py-2 text-blue-400 hover:bg-slate-700 hover:border-blue-500 transition-all" aria-label="Upload logo">
                                <PlusCircleIcon className="h-5 w-5" />
                                <span>ë¡œê³  ì¶”ê°€</span>
                              </button>
                            )}
                          </div>
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-slate-300 mb-2 print:text-slate-700">ì‹œí—˜ì§€ íŒŒì¼</label>
                          <FileUpload onFileChange={handleFileChange} />
                        </div>
                      </div>

                      {file && (
                        <div className="mt-6 p-4 bg-slate-700 border border-slate-600 rounded-lg flex items-center justify-between">
                          <div className="flex items-center gap-3">
                            <FileTextIcon className="h-6 w-6 text-blue-400" />
                            <span className="font-medium text-slate-100">{file.name}</span>
                          </div>
                          <button onClick={() => handleFileChange(null)} className="text-slate-400 hover:text-slate-200 text-2xl leading-none">&times;</button>
                        </div>
                      )}

                      <div className="mt-8 text-center">
                        <button onClick={handleAnalyze} disabled={!isAnalysisReady || isLoading} className="inline-flex items-center gap-2 bg-blue-500 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:bg-blue-600 disabled:bg-slate-700 disabled:text-slate-500 disabled:cursor-not-allowed transition-all duration-300 transform hover:scale-105" >
                          <BrainCircuitIcon className="h-5 w-5" />
                          ë¶„ì„ ì‹¤í–‰
                        </button>
                      </div>
                  </div>
                ) : (
                   <div>
                    <div className="mb-6 flex justify-end gap-4 print:hidden">
                      <button onClick={handleSaveAnalysis} disabled={isLoading} className="inline-flex items-center gap-2 bg-blue-500 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-blue-600 transition-colors disabled:bg-slate-700 disabled:cursor-not-allowed" >
                          <DownloadIcon className="h-5 w-5" /> ê²°ê³¼ ì €ì¥
                      </button>
                      <button onClick={handlePrint} disabled={isLoading} className="inline-flex items-center gap-2 bg-emerald-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-emerald-700 transition-colors disabled:bg-slate-700 disabled:cursor-not-allowed">
                          <PrintIcon className="h-5 w-5" /> ê²°ê³¼ ì¸ì‡„
                      </button>
                      <button onClick={handleReset} disabled={isLoading} className="bg-slate-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-slate-700 transition-colors disabled:bg-slate-700 disabled:cursor-not-allowed" >
                          ìƒˆë¡œìš´ ë¶„ì„ ì‹œì‘
                      </button>
                    </div>
                    
                    {isLoading && analysisResult.length === 0 && <Loader />}
                    
                    <AnalysisDisplay 
                      id="analysis-report"
                      markdownText={analysisResult}
                      logoUrl={logoUrl}
                      examInfo={{ academicYear, semester, examType, subjectName }}
                    />
                  </div>
                )}

                {error && (
                  <div className="bg-red-500/10 border border-red-500/30 text-red-400 px-4 py-3 rounded-lg relative my-4" role="alert">
                    <strong className="font-bold">ì˜¤ë¥˜: </strong>
                    <span className="block sm:inline">{error}</span>
                  </div>
                )}
              </main>
              <footer className="text-center py-4 text-slate-400 text-sm border-t border-slate-700 print:hidden">
                <p>Powered by Question Analysis Pro & Google Gemini</p>
              </footer>
            </div>
          </div>
        );
      };

      const container = document.getElementById('root');
      const root = ReactDOM.createRoot(container);
      root.render(<App />);
    </script>
</body>
</html>
